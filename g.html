<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Gemini Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    #chat { height: 300px; overflow-y: auto; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title">Gemini Chat</h1>

      <!-- APIキー入力フォーム -->
      <div id="keySection">
        <div class="field">
          <label class="label">Gemini APIキー</label>
          <div class="control">
            <input class="input" type="password" id="apiKeyInput" placeholder="あなたのAPIキーを入力">
          </div>
        </div>
        <button class="button is-link" onclick="saveApiKey()">開始する</button>
      </div>

      <!-- チャットUI -->
      <div id="chatSection" class="hidden">
        <div id="chat" class="box mb-3"></div>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="messageInput" class="input" type="text" placeholder="メッセージを入力…" onkeydown="if(event.key==='Enter')sendMessage()">
          </div>
          <div class="control">
            <button class="button is-info" onclick="sendMessage()">送信</button>
          </div>
        </div>
        <button class="button is-danger is-light mt-2" onclick="resetApiKey()">APIキーをリセット</button>
      </div>
    </div>
  </section>

  <script>
    let userApiKey = "";

    window.onload = () => {
      const savedKey = localStorage.getItem("geminiApiKey");
      if (savedKey) {
        userApiKey = savedKey;
        showChatUI();
      }
    };

    function saveApiKey() {
      const input = document.getElementById("apiKeyInput").value;
      if (!input) {
        alert("APIキーを入力してください");
        return;
      }
      userApiKey = input;
      localStorage.setItem("geminiApiKey", userApiKey);
      showChatUI();
    }

    function resetApiKey() {
      localStorage.removeItem("geminiApiKey");
      location.reload();
    }

    function showChatUI() {
      document.getElementById("keySection").classList.add("hidden");
      document.getElementById("chatSection").classList.remove("hidden");
    }

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const chat = document.getElementById("chat");
      const msg = input.value.trim();

      if (!msg) return;

      chat.innerHTML += `<p><strong>あなた:</strong> ${msg}</p>`;
      input.value = "";
      input.disabled = true;

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${userApiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: msg }] }] })
        });

        const data = await res.json();
        const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "(返答なし)";
        chat.innerHTML += `<p><strong>Gemini:</strong> ${reply}</p>`;
      } catch (e) {
        chat.innerHTML += `<p class="has-text-danger">エラー: APIリクエストに失敗しました。</p>`;
      }

      input.disabled = false;
    }
  </script>
</body>
</html>